---
title: "analysis1_最終モデル"
output: html_document
date: "2025-09-28"
---

```{r}
library(tidyverse)
library(dplyr)
library(ggplot2)
#install.packages("pacman")
library(pacman)
library("GGally")  #ggpairsはここに収録
library("ggthemes")
library(easystats)
library(ggeffects)
library(MASS)
library(lme4)
library(lavaan)       # 構造方程式モデル用
library(semPlot)      # パス図用
library(lavaanPlot)   # パス図生成用
```

```{r}
data_Expt <- read.csv("Experiment1.csv", header = T, fileEncoding = "cp932")
```

```{r}
data_Expt <- na.omit(data_Expt)
Expt_table <- data.frame(data_Expt[12], #年齢
                        data_Expt[13], #性別
                        data_Expt[14], #最終学歴
                        data_Expt[15], #個人収入
                        data_Expt[16] #世帯収入
                        )
BADE_table <- data.frame()
BADE_table <- data_Expt[,29:172]

#年齢の平均値と標準偏差を求める
age_ave <- mean(data_Expt[, 12])
age_sd <- sqrt(var(data_Expt[, 12]))

#各性別の人数を求める
man <- sum(data_Expt[, 13] == 1)
woman <- sum(data_Expt[, 13] == 2)
other <- sum(data_Expt[, 13] == 3) #その他
```

# BADE：シナリオ全体の各項目の平均を求める 1回目の解釈
```{r}
#シナリオ全体の各項目の平均を求める 1回目の解釈
sum_12 <- numeric(nrow(BADE_table))  # ベクトルとして初期化
mean_12 <- numeric(nrow(BADE_table)) # ベクトルとして初期化

#NL1
column_indices <- seq(1, ncol(BADE_table), by = 12)
sum_12 <- numeric(nrow(BADE_table))  # ベクトルとして初期化
mean_12 <- numeric(nrow(BADE_table)) # ベクトルとして初期化
for (i in 1:nrow(BADE_table)) {
  selected_values <- BADE_table[i, column_indices]
  numeric_values <- selected_values[sapply(selected_values, is.numeric) & !is.na(selected_values)]
  sum_12[i] <- sum(numeric_values, na.rm = TRUE)
  mean_12[i] <- mean(numeric_values, na.rm = TRUE)
}
BADE_table$mean_NL1 <- (mean_12)

#EL1
column_indices <- seq(2, ncol(BADE_table), by = 12)
for (i in 1:nrow(BADE_table)) {
  selected_values <- BADE_table[i, column_indices]
  numeric_values <- selected_values[sapply(selected_values, is.numeric) & !is.na(selected_values)]
  sum_12[i] <- sum(selected_values, na.rm = TRUE)
  mean_12[i] <- mean(numeric_values, na.rm = TRUE)
}
BADE_table$mean_EL1 <- (mean_12)

# Absurd1
column_indices <- seq(3, ncol(BADE_table), by = 12)
for (i in 1:nrow(BADE_table)) {
  selected_values <- BADE_table[i, column_indices]
  numeric_values <- selected_values[sapply(selected_values, is.numeric) & !is.na(selected_values)]
  sum_12[i] <- sum(numeric_values, na.rm = TRUE)
  mean_12[i] <- mean(numeric_values, na.rm = TRUE)
}
BADE_table$mean_Ab1 <- (mean_12)

#Truth1
column_indices <- seq(4, ncol(BADE_table), by = 12)
for (i in 1:nrow(BADE_table)) {
  selected_values <- BADE_table[i, column_indices]
  numeric_values <- selected_values[sapply(selected_values, is.numeric) & !is.na(selected_values)]
  sum_12[i] <- sum(selected_values, na.rm = TRUE)
  mean_12[i] <- mean(numeric_values, na.rm = TRUE)
}
BADE_table$mean_Tr1 <- (mean_12)


#シナリオ全体の各項目の平均を求める 2回目の解釈
sum_12 <- numeric(nrow(BADE_table))  # ベクトルとして初期化
mean_12 <- numeric(nrow(BADE_table)) # ベクトルとして初期化

#NL2
column_indices <- seq(5, ncol(BADE_table), by = 12)

for (i in 1:nrow(BADE_table)) {
  selected_values <- BADE_table[i, column_indices]
  numeric_values <- selected_values[sapply(selected_values, is.numeric) & !is.na(selected_values)]
  sum_12[i] <- sum(numeric_values, na.rm = TRUE)
  mean_12[i] <- mean(numeric_values, na.rm = TRUE)
}
BADE_table$mean_NL2 <- (mean_12)

#EL2
column_indices <- seq(6, ncol(BADE_table), by = 12)
for (i in 1:nrow(BADE_table)) {
  selected_values <- BADE_table[i, column_indices]
  numeric_values <- selected_values[sapply(selected_values, is.numeric) & !is.na(selected_values)]
  sum_12[i] <- sum(selected_values, na.rm = TRUE)
  mean_12[i] <- mean(numeric_values, na.rm = TRUE)
}
BADE_table$mean_EL2 <- (mean_12)

# Absurd2
column_indices <- seq(7, ncol(BADE_table), by = 12)
for (i in 1:nrow(BADE_table)) {
  selected_values <- BADE_table[i, column_indices]
  numeric_values <- selected_values[sapply(selected_values, is.numeric) & !is.na(selected_values)]
  sum_12[i] <- sum(numeric_values, na.rm = TRUE)
  mean_12[i] <- mean(numeric_values, na.rm = TRUE)
}
BADE_table$mean_Ab2 <- (mean_12)

#Truth2
column_indices <- seq(8, ncol(BADE_table), by = 12)
for (i in 1:nrow(BADE_table)) {
  selected_values <- BADE_table[i, column_indices]
  numeric_values <- selected_values[sapply(selected_values, is.numeric) & !is.na(selected_values)]
  sum_12[i] <- sum(selected_values, na.rm = TRUE)
  mean_12[i] <- mean(numeric_values, na.rm = TRUE)
}
BADE_table$mean_Tr2 <- (mean_12)


#シナリオ全体の各項目の平均を求める 3回目の解釈
#NL3
column_indices <- seq(9, ncol(BADE_table), by = 12)
sum_12 <- numeric(nrow(BADE_table))  # ベクトルとして初期化
mean_12 <- numeric(nrow(BADE_table)) # ベクトルとして初期化
for (i in 1:nrow(BADE_table)) {
  selected_values <- BADE_table[i, column_indices]
  numeric_values <- selected_values[sapply(selected_values, is.numeric) & !is.na(selected_values)]
  sum_12[i] <- sum(numeric_values, na.rm = TRUE)
  mean_12[i] <- mean(numeric_values, na.rm = TRUE)
}
BADE_table$mean_NL3 <- (mean_12)

#EL3
column_indices <- seq(10, ncol(BADE_table), by = 12)
for (i in 1:nrow(BADE_table)) {
  selected_values <- BADE_table[i, column_indices]
  numeric_values <- selected_values[sapply(selected_values, is.numeric) & !is.na(selected_values)]
  sum_12[i] <- sum(selected_values, na.rm = TRUE)
  mean_12[i] <- mean(numeric_values, na.rm = TRUE)
}
BADE_table$mean_EL3 <- (mean_12)

# Absurd3
column_indices <- seq(11, ncol(BADE_table), by = 12)

for (i in 1:nrow(BADE_table)) {
  selected_values <- BADE_table[i, column_indices]
  numeric_values <- selected_values[sapply(selected_values, is.numeric) & !is.na(selected_values)]
  sum_12[i] <- sum(numeric_values, na.rm = TRUE)
  mean_12[i] <- mean(numeric_values, na.rm = TRUE)
}
BADE_table$mean_Ab3 <- (mean_12)

#Truth3
column_indices <- seq(12, ncol(BADE_table), by = 12)
for (i in 1:nrow(BADE_table)) {
  selected_values <- BADE_table[i, column_indices]
  numeric_values <- selected_values[sapply(selected_values, is.numeric) & !is.na(selected_values)]
  sum_12[i] <- sum(selected_values, na.rm = TRUE)
  mean_12[i] <- mean(numeric_values, na.rm = TRUE)
}
BADE_table$mean_Tr3 <- (mean_12)
rm(selected_values)
```

# BADEのスコアリング
```{r}
EI <- ((BADE_table$mean_Ab1 + BADE_table$mean_Ab2 + BADE_table$mean_Ab3 + BADE_table$mean_NL3 + BADE_table$mean_EL3) + ((BADE_table$mean_Tr3) * (-1)))

PRB <- (BADE_table$mean_NL1 + BADE_table$mean_NL2 + BADE_table$mean_EL1 + BADE_table$mean_EL2 + BADE_table$mean_Tr1 + BADE_table$mean_Tr2)
BACE <- ((BADE_table$mean_Tr3) - (BADE_table$mean_Tr1))

BADE_table <- cbind(BADE_table, EI)
BADE_table <- cbind(BADE_table, PRB)
BADE_table <- cbind(BADE_table, BACE)

Expt_table <- cbind(Expt_table, EI)
Expt_table <- cbind(Expt_table, PRB)
Expt_table <- cbind(Expt_table, BACE)
```

# 疑似科学信奉尺度（項目7だけ逆転項目なので値を反転）
```{r}
gizikagaku <- data_Expt[, 173:191] %>%
  mutate(疑似科学信奉尺度7_逆転 = case_when(
    疑似科学信奉尺度7 == 1 ~ 5,
    疑似科学信奉尺度7 == 2 ~ 4,
    疑似科学信奉尺度7 == 3 ~ 3,
    疑似科学信奉尺度7 == 4 ~ 2,
    疑似科学信奉尺度7 == 5 ~ 1
  ))

# 列名整理
colnames(gizikagaku) <- c(
  paste0("疑似科学信奉尺度", 1:6),
  paste0("疑似科学信奉尺度", 7:19),
  "疑似科学信奉尺度7_逆転"
)

# 値反転前の7列目を削除して逆転列に置き換え
gizikagaku <- gizikagaku[, -7]

# 個人ごとの平均スコア
gizi_ave <- rowMeans(gizikagaku, na.rm = TRUE)

# 全体平均と標準偏差
gizi_overall_mean <- mean(gizi_ave, na.rm = TRUE)
gizi_overall_sd <- sd(gizi_ave, na.rm = TRUE)

# Cronbach α
gizi_alpha <- psych::alpha(gizikagaku)$total$raw_alpha

# データフレームに平均列追加
gizikagaku <- cbind(gizikagaku, gizi_ave)
Expt_table <- cbind(Expt_table, gizi_ave)

# 出力
cat("疑似科学信奉尺度 全体平均:", round(gizi_overall_mean, 3), "\n")
cat("疑似科学信奉尺度 全体SD:", round(gizi_overall_sd, 3), "\n")
cat("疑似科学信奉尺度 Cronbach α:", round(gizi_alpha, 3), "\n")
rm(gizikagaku)
```

# 陰謀論信念 (CMQ-J)
```{r}
# データ抽出
CMQ_table <- data_Expt[, 192:196]

# 個人ごとの平均スコア
cmq_ave <- rowMeans(CMQ_table, na.rm = TRUE)

# 全体平均と全体SD（個人平均のSD）
cmq_overall_mean <- mean(cmq_ave, na.rm = TRUE)
cmq_overall_sd <- sd(cmq_ave, na.rm = TRUE)

# Cronbach α
cmq_alpha <- psych::alpha(CMQ_table)$total$raw_alpha

# データフレームに平均列追加
CMQ_table <- cbind(CMQ_table, cmq_ave)
Expt_table <- cbind(Expt_table, cmq_ave)

# 出力
cat("CMQ尺度 全体平均:", round(cmq_overall_mean, 3), "\n")
cat("CMQ尺度 全体SD:", round(cmq_overall_sd, 3), "\n")
cat("CMQ尺度 Cronbach α:", round(cmq_alpha, 3), "\n")
rm(CMQ_table)
```

# 科学的推論能力 (SRS)
```{r}
suiron_table <- data_Expt[,197:208]

# 正解/不正解を0,1に変換
suiron_table <- suiron_table %>%
  mutate(
    suiron_1  = if_else(科学的推論能力1  == 1, 1, 0),
    suiron_2  = if_else(科学的推論能力2  == 2, 1, 0),
    suiron_3  = if_else(科学的推論能力3  == 1, 1, 0),
    suiron_4  = if_else(科学的推論能力4  == 2, 1, 0),
    suiron_5  = if_else(科学的推論能力5  == 2, 1, 0),
    suiron_6  = if_else(科学的推論能力6  == 2, 1, 0),
    suiron_7  = if_else(科学的推論能力7  == 1, 1, 0),
    suiron_8  = if_else(科学的推論能力8  == 2, 1, 0),
    suiron_9  = if_else(科学的推論能力9  == 1, 1, 0),
    suiron_10 = if_else(科学的推論能力10 == 2, 1, 0),
    suiron_11 = if_else(科学的推論能力11 == 2, 1, 0),
    suiron_12 = if_else(科学的推論能力12 == 2, 1, 0)
  )
suiron_score <- suiron_table[, 13:24]

# 個人平均
suiron_ave <- rowMeans(suiron_score, na.rm = TRUE)

# 全体平均・全体SD（個人平均のSD）
suiron_overall_mean <- mean(suiron_ave, na.rm = TRUE)
suiron_overall_sd <- sd(suiron_ave, na.rm = TRUE)

# Cronbach α
suiron_alpha <- psych::alpha(suiron_score)$total$raw_alpha

# データフレームに平均列追加
suiron_score <- cbind(suiron_score, suiron_ave)
Expt_table <- cbind(Expt_table, suiron_ave)

# 出力
cat("科学的推論能力 全体平均:", round(suiron_overall_mean, 3), "\n")
cat("科学的推論能力 全体SD:", round(suiron_overall_sd, 3), "\n")
cat("科学的推論能力 Cronbach α:", round(suiron_alpha, 3), "\n")
rm(suiron_table, suiron_score)
```

# 被害妄想（値を反転処理）
```{r}
# 被害妄想データ抽出
higai_table <- data_Expt[, 209:226]

# 値を逆転処理（1→5, 2→4, …）
higai_table_rev <- as.data.frame(lapply(higai_table, function(x) {
  case_when(
    x == 1 ~ 5,
    x == 2 ~ 4,
    x == 3 ~ 3,
    x == 4 ~ 2,
    x == 5 ~ 1
  )
}))

# 個人ごとの平均
higai_ave <- rowMeans(higai_table_rev, na.rm = TRUE)

# 全体平均・全体SD（個人平均のSD）
higai_overall_mean <- mean(higai_ave, na.rm = TRUE)
higai_overall_sd <- sd(higai_ave, na.rm = TRUE)

# Cronbach α
higai_alpha <- psych::alpha(higai_table_rev)$total$raw_alpha

# データフレームに平均列追加
higai_table_rev <- cbind(higai_table_rev, higai_ave)
Expt_table <- cbind(Expt_table, higai_ave)

# 出力
cat("被害妄想尺度 全体平均:", round(higai_overall_mean, 3), "\n")
cat("被害妄想尺度 全体SD:", round(higai_overall_sd, 3), "\n")
cat("被害妄想尺度 Cronbach α:", round(higai_alpha, 3), "\n")
rm(higai_table, higai_table_rev)
```

# CRT あっていたら1, 間違っていたら0とする
```{r}
# CRTデータ抽出
crt_table <- data_Expt[, 227:229]

# 正解/不正解を0,1に変換
crt_table <- crt_table %>%
  mutate(
    crt_1 = if_else(CRT1 == 50, 1, 0),
    crt_2 = if_else(CRT2 == 5, 1, 0),
    crt_3 = if_else(CRT3 == 47, 1, 0)
  )

# 正解列だけ抽出
crt_score <- crt_table[, 4:6]

# 個人平均
crt_ave <- rowMeans(crt_score, na.rm = TRUE)

# 全体平均・全体SD（個人平均のSD）
crt_overall_mean <- mean(crt_ave, na.rm = TRUE)
crt_overall_sd <- sd(crt_ave, na.rm = TRUE)

# Cronbach α
crt_alpha <- psych::alpha(crt_score)$total$raw_alpha

# データフレームに平均列追加
crt_score <- cbind(crt_score, crt_ave)
Expt_table <- cbind(Expt_table, crt_ave)

# 出力
cat("CRT尺度 全体平均:", round(crt_overall_mean, 3), "\n")
cat("CRT尺度 全体SD:", round(crt_overall_sd, 3), "\n")
cat("CRT尺度 Cronbach α:", round(crt_alpha, 3), "\n")
rm(crt_score, crt_table)
```

# BADEのα係数を求める
```{r}
library(psych)
results <- data.frame(
  Scale = c("EI", "PRB", "BACE", "JPC", "SRS", "CRT", "CMQ", "PBS"),
  Mean = c(mean(BADE_table$EI, na.rm=TRUE),
           mean(BADE_table$PRB, na.rm=TRUE),
           mean(BADE_table$BACE, na.rm=TRUE), 
           higai_overall_mean,
           suiron_overall_mean,
           crt_overall_mean,
           cmq_overall_mean,
           gizi_overall_mean),
  SD   = c(sd(BADE_table$EI, na.rm=TRUE),
           sd(BADE_table$PRB, na.rm=TRUE),
           sd(BADE_table$BACE, na.rm=TRUE),
           higai_overall_sd,
           suiron_overall_sd,
           crt_overall_sd,
           cmq_overall_sd,
           gizi_overall_sd),
  Alpha = c(
    alpha(BADE_table[, c("mean_Ab1", "mean_Ab2", "mean_Ab3", "mean_NL3", "mean_EL3", "mean_Tr3")])$total$raw_alpha,
    alpha(BADE_table[, c("mean_NL1", "mean_NL2","mean_EL1", "mean_EL2", "mean_Tr1", "mean_Tr2")])$total$raw_alpha,
    alpha(BADE_table[, c("mean_Tr1", "mean_Tr3")])$total$raw_alpha,
    higai_alpha,
    suiron_alpha,
    crt_alpha,
    cmq_alpha,
    gizi_alpha
  )
)

results
```

# 相関分析
```{r}
Sanford <- data.frame(Expt_table[, 6], Expt_table[, 7], Expt_table[, 8], Expt_table[, 9], Expt_table[, 10], Expt_table[, 11], Expt_table[, 12], Expt_table[, 13])
colnames(Sanford)<- c("EI", "PRB", "BACE", "PBS", "CMQ", "SRS", "JPC", "CRT")
res <-correlation::correlation(Sanford, include_factors = TRUE,  na.rm = TRUE, digits = 3)
#summary(res)

graph <- ggpairs(Sanford)
p <- Sanford %>% 
      dplyr::select(EI, PRB, BACE, PBS, CMQ, SRS, JPC, CRT) %>% 
      ggpairs(lower = list(continuous = wrap("smooth", size = 1.5, alpha = 0.8)),
          #散布図付き回帰線の散布図のドットサイズを1.5に，また透過率を0.8に
          
          upper = list(continuous = wrap("cor", size = 2)),
          #相関係数の文字サイズを5に
          
          diag = list(continuous = wrap("densityDiag", alpha = 0.5))
          #3種の密度図が重なるので，透過率0.5にして可視化
          
          ) + theme(axis.text= element_text(size=4),legend.title = element_text(size=7),legend.text = element_text(size=7),axis.title = element_text(size=7),plot.title= element_text(size=7),strip.text=element_text(size=7))
summary(res)
```

# パス解析（ベースモデル）
```{r}
model_Sanford <- '
CMQ ~~ PBS
EI ~~ PRB
PRB ~~ BACE
JPC ~~ CRT
EI ~ JPC + CRT
PRB ~ JPC + CRT
BACE ~ JPC + CRT
SRS ~ JPC + CRT + EI + PRB + BACE
CMQ ~ JPC + CRT + EI + PRB + BACE + SRS
PBS ~ JPC + CRT + EI + PRB + BACE + SRS
'


# データの標準化
Sanford_scaled <- scale(Sanford)  
# Sanfordが元のデータセット

# モデルを適合
fit_model <- lavaan::sem(model_Sanford, data = Sanford_scaled, estimator = "WLSMV")

# 結果を確認
summary(fit_model, standardized = TRUE, fit.measure = TRUE)

# パス解析図を生成
lavaanPlot(model = fit_model, coefs = TRUE, sig = .05)  # 有意な関係のみパス係数を表示
```
# モデルの適合度を求める（ベースモデル）
```{r}
#install.packages('psych')
library(psych)

fitMeasures(fit_model, c("srmr", "cfi", "rmsea", "agfi", "ecvi"))
summary(fit_model, fit.measures=TRUE)

summary(fit_model)

# modindices(fit_model, sort. = TRUE, minimum.value = 10)

```

#############################
# 改良モデル 
```{r}
#改良モデル（自由度あり）
model_Sanford_fd2 <- '
## 相関
CMQ ~~ PBS
EI  ~~ BACE
EI  ~~ PRB
BACE  ~~ PRB

## 回帰
EI   ~ JPC + CRT
PRB  ~ JPC + CRT
BACE ~ JPC + CRT
SRS  ~ CRT  + PRB + EI
CMQ  ~ SRS + PRB + JPC + CRT + EI
PBS  ~ SRS + PRB +  CRT+ EI
'

# データの標準化
Sanford_scaled <- scale(Sanford)  

# モデルを適合
fit_model_fd2 <- lavaan::sem(model_Sanford_fd2, data = Sanford_scaled, estimator = "WLSMV",
                 auto.cov.y = FALSE)

# 結果を確認
summary(fit_model_fd2, standardized = TRUE, fit.measure = TRUE)

# パス解析図を生成
lavaanPlot(model = fit_model_fd2, coefs = TRUE, sig = .05)

# 修正指標
modificationindices(fit_model_fd2, sort. = TRUE, maximum.number = 20)

fitMeasures(fit_model_fd2, c("srmr", "cfi", "rmsea", "agfi", "ecvi"))

```